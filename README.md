# Malware Stager Deobfuscation

During a recent challenge, I received an obfuscated malware stager that was a PowerShell script. This was my first time tackling de-obfuscation and I'm sure this was an easy sample, because I've seen video of analysts trying to breakdown multi-layer malware and it looks intimidating. 
<br>
<br>
<b>Sample:</b>
<br>
<br>
<a href="https://imgur.com/HiZumfF"><img src="https://i.imgur.com/HiZumfF.jpg" title="source: imgur.com" /></a>
<br>
<br>
If we look at this script, it's clear that it is encoded with base64, but they’re also using other elements to obfuscate. The { } throughout the malware and the –f key at the bottom is indicative of a PowerShell string.format array.
<br>
<br>
<a href="https://imgur.com/kXbg0y3"><img src="https://i.imgur.com/kXbg0y3.jpg" title="source: imgur.com" /></a>
<br>
<br>
We can use PowerShell to decipher the order in which to replace {2},{1},{0} with “=”,”P”,”T”. If you’re running Kali you can run PowerShell via pwsh.  
<br>
<br>
So, {2} = "P", {1} = "t", {0} = "="
<br>
<br>
<a href="https://imgur.com/yV8ym6Y"><img src="https://i.imgur.com/yV8ym6Y.jpg" title="source: imgur.com" /></a>
<br>
<br>
After replacing those characters it’s a bit cleaner, but if this is base64, there is still an issue. Base64 only uses alpha-numeric characters and “/” “+”. So, we must remove all the single quote symbols.
<br>
<br>
Utilizing CyberChef I removed the single quotes and tried to decode the string, but it was decoding into nonsense.
<br>
<br>
<a href="https://imgur.com/9qT0veh"><img src="https://i.imgur.com/9qT0veh.jpg" title="source: imgur.com" /></a>
<br>
<br>
Next, I decided to remove the apostrophes and the “+” symbol they were surrounding, followed by decoding the cleaned-up string. It decoded as unreadable data gain, so I ran file against the malware, and it stated that it was a gzip compressed file.
<br>
<br>
<a href="https://imgur.com/ZA6Q91b"><img src="https://i.imgur.com/ZA6Q91b.jpg" title="source: imgur.com" /></a>
<br>
<br>
I renamed the malware file, malware.gz and then used gzip to decompress it.
<br>
<br>
<a href="https://imgur.com/qiVBhpC"><img src="https://i.imgur.com/qiVBhpC.jpg" title="source: imgur.com" /></a>
<br>
<br>
This gave me the ability to read the obfuscated code and glean the information needed to finish the challenge. 
<br>
<br>
<a href="https://imgur.com/E99CE4p"><img src="https://i.imgur.com/E99CE4p.jpg" title="source: imgur.com" /></a>
<br>
<br>
<b>Lessons Learned:</b>
<br>
<br>
I will continue to work on my skills to be able to extract data/characters from large strings. I tried to use “cut”, but it proved too difficult and using string.replace in Python kept giving me a “string termination” error. Utilizing regex would probably have been the best bet, but my skills are currently very neophyte. 
<br>
<br>
I would also take care and be very careful when removing or replacing characters in these strings, because it can throw off the base64 decoding. 



























